## 背景
　　系统中有个功能,信息的导入,由于信息导入功能比较耗时,使用同步接口功能的时候,经常会超过前端设置的30秒钟超时时间,导致后面导入的资源成功,失败,异常等等信息无法获取.
　  刚好系统中有一个 websocket 技术,用来实现客户端浏览器端接收系统产生的各种各样的操作审批消息,利用这个地方,似乎也可以实现导入的资源进度提示,这样就解决了前端超时的问题.

## 实现细节

　　后端将导入进度的具体业务实现代码处,添加一个导入进度的信息提示功能,每2秒钟发送一次导入进度消息,消息在通过 websocket 发送给用户浏览器,前端加载接收到的导入进度消息,用来实现进度提醒的功能.

## 问题
　　系统在开发测试区进行测试这个导入功能的时候,没有问题,可以实施的显示导入进度条,但是部署到系统上之后,就遇到了异常情况

- **进图条反馈信息总是乱跳,不能够连续提示导入进度状况,最后结束的标识信息也是时而收到,时而收不到**

  　　这样的情况只出现在生产系统中,开发测试区的环境均没有这种情况.后来仔细对比了一下系统中的不同点,发现开发测试区和生产区的区别在于,生产区的 controller 与 service 工程是多节点部署的,但是开发测试区,均是单节点.  
  　　因为系统工程使用的 dubbo 框架,展现层 controller 与业务处理层 service 是分开部署的. 我们的websocket 建立的连接是用户客户端与 controller 节点建立的,没有直接与我们的 service 层建立连接,但是我们导入信息的落库处理是在 service 层进行的.所以我们需要在 service 层进行导入信息处理的过程中,通过 dubbo 调用 controller 层的 websocket 方法.因为使用 dubbo 调用 controller 方法是随机访问,因此导致消息不一定每次都是返回给与客户端建立连接的 controller,这样就导致导入信息总是乱跳的情况.

  **解决办法**:  
  解决这个问题,我这边改造了一下 controller 中发送 websocket 导入进度消息的方法,在这个方法执行前,先判断导入进度的操作的登录用户的 websocket 的 session 在不在我这个节点中,在就发送,不在就将消息转发至有这个用户的session 的节点上去

- **登录系统后,马上进行资源导入可以显示导入进度条,但是登录系统操作一段时间后,使用导入功能,不能够显示进度条信息**  
  生产系统使用的是 Nginx 做反向代理,websocket 需要在 Nginx 添加配置才可以保持长连接.
  但是 Nginx 的连接保持时长,默认是1分钟,这就导致我们与客户端建立的连接在1分钟后,就自动被 Nginx 切断,这就导致我们的 websocket 消息总是会出现无法接收到小的情况.
  **解决办法**:  将 Nginx 的连接保持时长参数加长至我们的用户登录保活时间.
