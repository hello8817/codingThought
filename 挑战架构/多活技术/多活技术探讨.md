## 引言

最近接到了一个比较有挑战的工作,需要提供一份异地多活方案,具体需求是这样的:
* 多个跨地域的数据中心，每个数据中心都要承担用户的读写流量，多点写入，保证最小延迟，
* 任意一个数据中心出问题的时候，其他中心都可以分钟级去接管用户的流量

刚开始遇到这样的要求,完全没有任何头绪,接下来先让我搞清楚为什么要做多活这个事情吧

### 异地多活架构

**异地**:不在同一个地理位置
**多活**:分属不同地域的系统,均能够提供业务

判断一个系统是否符合异地多活,主要需要满足两个标准:
1. 正常情况下,用户无论访问哪一个地点的业务系统,都能够得到正确的业务服务.
2. 某一个地方的出现业务异常时,用户访问其他地方的正常业务系统,能够得到正确的业务服务.

如要满足如上两个标准的要求,主要以下挑战:
* 异地多活的架构非常复杂
* 需要多个机房部署独立的业务系统,成本非常高

### 架构模式

异地多活架构,主要分为 **同城异区**  **跨城异地**  **跨国异地**

**同城异区**: 同一个城市,不同的区域,两个机房使用专线连接,构建机房间的高速网络通道.因此我们可以将两个机房逻辑上看成是一个机房,这样从设计方案上来讲,降低了一定的设计成本.
  * 优点: 有效对抗机房火灾,机房停电,机房空调故障等机房级别故障灾难,结合复杂度/成本/故障发生概率来综合考虑, **同城异区** 是应对机房级别故障的很好的选择
  * 缺点: 无法应对极端灾难事件,如城市停电,地震等等

**跨城异地**: 不同城市的不同机房,距离很远,导致来回一个请求的时间很长.
  * 优点: 能够很好的对抗极端灾难场景
  * 缺点: 无法支持强一致性要求的数据,例如银行存款余额/支付宝余额等等

金融相关场景不适用跨城异地场景  
例如: 系统分别部署在广州和北京，那么如果挖掘机挖断光缆后，会出现如下场景

用户 A 余额有 10000 元钱，北京和广州机房都是这个数据。  
用户 A 向用户 B 转了 5000 元钱，这个操作是在广州机房完成的，完成后用户 A 在广州机房的余额是 5000 元。  
由于广州和北京机房网络被挖掘机挖断，广州机房无法将余额变动通知北京机房，此时北京机房用户 A 的余额还是 10000 元。  
用户 A 到北京机房又发起转账，此时他看到自己的余额还有 10000 元，于是向用户 C 转账 10000 元，转账完成后用户 A 的余额变为 0。  
用户 A 到广州机房一看，余额怎么还有 5000 元？于是赶紧又发起转账，转账 5000 元给用户 D；此时广州机房用户 A 的余额也变为 0 了。  
最终，本来余额 10000 元的用户 A，却转了 20000 元出去给其他用户。  

跨城异地更适用于 用户登录（数据不一致时用户重新登录即可）、新闻类网站（一天内的新闻数据变化较少）、微博类网站（丢失用户发布的微博或者评论影响不大）这些类别的系统

**跨国异地**: 跨国异地的场景延时更长,但是这样的场景更多的含义不是为了抵御灾难,更对的是为不同地区的用户提供服务
* 为不同地区的用户提供相同的服务:比如说,不同区域的亚马逊账号均不通用,但是均可以在本区域使用对应的服务  
* 只读类服务: 比如说维基百科,搜索引擎,等等;不同国家使用 Google 搜索,结果基本上都是相同的,这些结果如果有几秒钟,或者几分钟的延迟,对于用户来说并没有什么影响  

## 多活案例

* 
